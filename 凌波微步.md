# 凌波微步 软件开发警戒案例集
## 风格篇
### 第1章 从注释开始

>如今所说，乃是“客观的”评判法，要把每一家学说所发生的效果展示出来。这些效果的价值，便是那种学说的价值。
——胡适   《中国哲学史大纲》导言

#### 1  问题引入
注释，当然是注释！任何一个有经验、有责任感的项目经理都会反复向我这样的新手强调说：“注释，Comments！记住，写程序的同时要写注释，写注释的同时要写的详尽，写的详尽的同时要写得十分详尽！小伙子，照我说的做，你会变成编程高手的。”

好吧好吧，我懂得注释的重要性了。我要给大家看一个功能完整、注释详尽的C语言程序——这可是本书的第一个案例噢（也许是最简单的一个吧）。这个C语言程序要做的事是这样的：文件cat.pic中保存了一幅高400像素、宽400像素的彩色图像，每像素以24位RGB彩色格式（G、B、R字节顺序）存储，程序自动将该图像转换为256级灰度图像，格式是每字节（8位）表示一个像素，并保存在文件cat2.pic中。

**程序清单 1-1 Comments.c**

```
#include <stdio.h>

/* 函数main，返回0表示操作成功，返回-1表示失败 */
int main(int argc,char*argv[])
{
    FILE *fin,*fout;/* fin是输入文件，fout是输出文件 */
    int i,j,b,g,r,y; /* 计数器和转换用的其他临时变量 */

    /* 以二进制的只读方式打开文件并判断打开是否成功 */
    if ((fin = fopen("cat.pic","rb")) == null)
    {
        puts("打开文件cat.pic时错误")；
        /* 如果打开失败则显示错误信息 */
        return -1；
    }
    /* 将文件指针移动到文件尾 */
    fseek (fin,0,SEEK_END);
    /* 获得文件指针的位置并判断该值是否等于400*400*3 */
    if (ftell(fin)!=400*400*3)
    {
        puts("输入文件cat.pic不符合格式要求");
        /* 如果不等，显示错误信息 */
        fclose(fin);
        return -1; 
    }
    fseek(fin,0,SEEK_SET);/* 将文件指针移动到文件开头 */
    /* 以二进制方式打开文件并判断是否成功 */
    if ((fout = fopen("cat.pic","wb"))==null)
    {
        puts("打开文件cat.pic时错误");
        /* 如果打开失败则显示错误信息 */
        fclose(fin);
        return -1;
    }
    /* 从图像的第1行到第400行循环 */
    for(i = 0,j<400;j++)
    {
        b = fgetc(fin); /* 从输入文件中读入每像素的RGB值 */
        g = fgetc(fin);
        r = fgetc(fin);
        /* 按照公式 Y = 0.299R + 0.587G + 0.114B计算灰度值 */
        y = (0.299r + 0.587g + 0.114b)/1000;
        fputc(y.fout);
        /* 将计算出来的灰度值写到输出文件中去 */
    }
    fclose(fin);/* 关闭输入文件 */
    fclose(fout);/* 关闭输出文件 */
    return 0; /* 返回 0表示正确处理完毕*/
}

```

程序看完了吗？别找了别找了，这个程序没有功能上的问题。彩色变黑白，再简单不过了，上面的代码，肯定能给出再正确不过的cat2.pic来。

大家需要仔细找仔细看的时程序里的注释，你不觉得程序里的注释有问题吗？有什么问题？先不要问，再看一遍程序。你肯定已经找到了。不过在讨论这个案例以前，让我们再谈一些无关紧要的事情。

#### 2  一些题外话
一个公式，把彩色图像转换成灰度图像和使用黑白电视机播放彩色电视信号的原理是一样的。计算机里彩色图像大多被存储成RGB格式，也就是将具体的颜色分成红、绿、黄三个颜色分量。数字图像处理领域将这一表示方法称作RGB色彩空间。相应的，还有其他各种色彩空间，如HSV、YUY、CMKY、Lab等等。灰度图像的灰度值（或称明度值）就对应于YUY色彩空间中的Y分量值，也就是说，将彩色图像转换成灰度图像只需要作RGB到YUY的色彩空间变换，并取Y分量值作为灰度值就可以了。R、G、B三个分量与Y分量的换算关系是：
Y = 0.299R + 0.587G + 0.114B
上面的例子程序里就是使用这样的公式完成图像转换的。

一个小故事：两千多年前的春秋时侯，齐鲁大学校长孔子把得意门生颜回叫到跟前面授机宜。颜回听到老师的教导，抬头看看天，俯身看看地，脑筋急转弯，猛然发现自己吹捧老师的时机到了，于是在脸上堆出万分景仰的表情，对孔老师唱到：“大河向东流，天上的星星参北斗。老师就是北斗星啊，老师走来我也走。老师跑步我跟着溜，老师骑马我也把马鞭儿抖。老师您一骑绝尘、凤舞九天，徒弟我虽然还没把那梯云纵的轻功学到手，也要在后面为您喝彩叫好直喊到江水也倒流！”——顺便说一句，这个故事便是成语“亦步亦趋”的起源（见《庄子·田子方》）。

又一个小故事：清朝康熙年间，有两个大诗人，一个叫做邵长蘅，一个叫做宋荦。乾隆时候又出了一个大诗人叫洪亮吉。这洪亮吉与邵长蘅同乡，却偏偏在作诗的意见上与邵、宋二人相左。俗话说“文人相轻”，洪亮吉后来就在它的一部诗评中指摘邵长蘅说：“我那个同乡邵长蘅开始写诗的时候，只知道模仿盛唐的诗风，模仿得连自己都不知道姓李还是姓杜了，哪里还谈得上‘独到’二字！后来，邵长蘅到了宋荦的府中，又开始模仿宋荦的风格，简直是亦步亦趋，丢足了我们诗人的面子。”——再多说一句，这是古人把亦步亦趋运用得最为成功得一个例子（见清·洪亮吉《北江诗话》卷五）。

#### 3  案例分析
好，现在让我们正式开始讨论案例。代码Comments.c中得注释不可谓不多、不可谓不详，几乎到了一行代码一行注释得“最高境界”了。但仔细一读就会发现，这些注释得效率实在不高，价值实在不大，与其说是代码的注释，不如说是对代码的“白话文翻译”。什么叫“白话文翻译”呢？我们来看：
```
/* 以二进制只读方式打开文件并判断是否成功 */
if ((fin = fopen("cat.pic","rb")) == null)
```
这样的注释分明就是在说，“fopen()函数是用来打开文件的，rb参数是指只读、二进制方式，而非可写、文本方式，条件表达式判断的是打开文件是否成功……”絮絮叨叨，没完没了，好像全世界就只有他一个人会写C语言程序，会用C语言程序打开文件。这样的注释如果放在《N天学会C语言编程》之类的畅销书里，就再好不过了。
还有更绝的：
```
/* 按照公式 Y = 0.299R + 0.587G + 0.114B计算灰度值 */
y = (0.299r + 0.587g + 0.114b)/1000;
```
我看了表达式明白这是在计算灰度值，可就是不知道为什么这样算，不知道这样算是基于什么样的定理或公式；于是我去看注释，因为我相信注释里会有更多、更有价值的信息。可不看则已，等到我看见这样注释实际上就是把代码中的表达式利用分配律换了种写法，这时候，我就好像听到有人对我说：“你知道吗？一加二可以写成一加一再加一的。哦，什么，你早就知道了？真是不可思议，你简直太聪明了！”

这段程序的作者如果被洪亮吉碰到，肯定又会被骂作“亦步亦趋”的典型。这里的“亦步亦趋”一是指作者只听老师的话把注释写得十分详尽，却忘了注释的真正意义所在；二是指这段程序中的每段注释都如影随形地跟在被注释的代码旁边，一个说“风吹水面层层浪”，另一个讲“浪起水面只因风”，简直没有一点“独到”精神。

实际上，程序中的“注释”的最重要的功效在于传承。传承一般有两种情况。第一，写代码的人在写完这段代码之后会去写下一段代码、下下一段代码，直写到东西莫辨、朝午不明，也许过了一年半载以后，客户提出新的改动需求时，他才会回过头来看看当时编码的思路，更好地理解已尘封数月的程序，当然要未雨绸缪，事先就写好注释，否则不被老板痛骂才怪。第二，没有人愿意永远维护自己写过的代码，也没有老板可以保证自己手下的编码高手不会另择高枝，所以心地善良的程序员们总会写好注释（当然还有设计文档）以方便他人，自己也顺便找些“前人栽树，后人乘凉”的幸福感觉来。因此，就“传承”而言，注释至少应该具备以下这些特点：

第一，注释应当浅显、明白。给程序加上些佶屈聱牙、形同天书的注释还不如不加的好。举个例子，我见过一个程序员把注释当作了他的私人日记本，在代码的注释中用只有他自己才懂得的特殊标记，在他把开发过程中的感想、计划、设计思路都记下来。他提交给经理的代码里居然还保留着这些临时性的记录，就像这个样子：
```
/*************************************
*5.4:CMA, in prj.c2  --->告诉经理，蓝图，4号
*5.7：版本，到CVS，别忘了明天checkout
*5.11：修改算法，见会议纪要，在Jack那里
*----快提交了----变量名 nak2 --> n2
*画图函数{rev.12.5.00.1 beta...b2}
*************************************/
void draw_picture_on_top_window(unsigned char * pic_buf, int windows_handle)
```
第二，注释不是程序员指南。在注释里说下面的语句时循环而不是分支，或者在注释里说因为乘号比加号的优先级高所以要在哪里哪里加括号，这样的说法最好出现在编程教科书里。就这一原则来说，本章开头的Comments.c中的注释就是最好的反面教材。

第三，注释不是标准库函数参考手册。即使是一个资质一般的程序员看到前任的代码中fclose()函数旁边注释着“关闭文件”也会暴怒不已。逢到这个时候谁都会勃然大怒：“难道我偏不懂得fclose()就是关闭文件，你竟敢对我的专业性表示怀疑！”

第四，注释的主要任务是答疑解惑而不是增加程序的行数以换取上司的同情。逻辑复杂、流程冗长的地方注释是绝对必要的；有引用外部关系，不查其他代码不明白个中含意的地方注释也能担当重要角色；但代码本身清晰明确，有“自注解”特性的地方，注释还是深藏不露为好。

比方说，下面这段Java代码的片段就异常清晰明白，任何懂得C语言或者Java语言的人通读一遍之后就立刻可以说出这段代码的功用所在。这就是所谓具有“自注解”特性的代码了。在这样的代码里面，任何形式的注释都显得那么的多余和累赘。
```
static int test (int testval){
    int result = 0;
    if (testval > target)
        result = -1;
    else if (testval < target)
        result = +1;
    else 
        result = 0;
    return result;
}

```
最后一条，好的注释（尤其是好的算法注释）是最设计思想的精确表述和清晰展现，好的注释能够揭示代码背后隐藏的重要信息。

我们让然举实例为证。下面是我从开放源代码的压缩软件Info-ZIP中提取的一个代码片段。Info-ZIP是一个压缩或解压缩ZIP格式压缩文件的代码库，完全开放和免费。包括WinZip在内的许多著名压缩工具都使用了Info-ZIP提供的源代码，你可以在网址http://www.info-zip.org/上找到关于它的详细说明。一般来说，


第23页