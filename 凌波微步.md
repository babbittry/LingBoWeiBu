# 凌波微步 软件开发警戒案例集
## 风格篇
### 第1章 从注释开始

>如今所说，乃是“客观的”评判法，要把每一家学说所发生的效果展示出来。这些效果的价值，便是那种学说的价值。
——胡适   《中国哲学史大纲》导言

#### 1  问题引入
注释，当然是注释！任何一个有经验、有责任感的项目经理都会反复向我这样的新手强调说：“注释，Comments！记住，写程序的同时要写注释，写注释的同时要写的详尽，写的详尽的同时要写得十分详尽！小伙子，照我说的做，你会变成编程高手的。”

好吧好吧，我懂得注释的重要性了。我要给大家看一个功能完整、注释详尽的C语言程序——这可是本书的第一个案例噢（也许是最简单的一个吧）。这个C语言程序要做的事是这样的：文件cat.pic中保存了一幅高400像素、宽400像素的彩色图像，每像素以24位RGB彩色格式（G、B、R字节顺序）存储，程序自动将该图像转换为256级灰度图像，格式是每字节（8位）表示一个像素，并保存在文件cat2.pic中。

**程序清单 1-1 Comments.c**

```
#include <stdio.h>

/* 函数main，返回0表示操作成功，返回-1表示失败 */
int main(int argc,char*argv[])
{
    FILE *fin,*fout;/* fin是输入文件，fout是输出文件 */
    int i,j,b,g,r,y; /* 计数器和转换用的其他临时变量 */

    /* 以二进制的只读方式打开文件并判断打开是否成功 */
    if ((fin = fopen("cat.pic","rb")) == null)
    {
        puts("打开文件cat.pic时错误")；
        /* 如果打开失败则显示错误信息 */
        return -1；
    }
    /* 将文件指针移动到文件尾 */
    fseek (fin,0,SEEK_END);
    /* 获得文件指针的位置并判断该值是否等于400*400*3 */
    if (ftell(fin)!=400*400*3)
    {
        puts("输入文件cat.pic不符合格式要求");
        /* 如果不等，显示错误信息 */
        fclose(fin);
        return -1; 
    }
    fseek(fin,0,SEEK_SET);/* 将文件指针移动到文件开头 */
    /* 以二进制方式打开文件并判断是否成功 */
    if ((fout = fopen("cat.pic","wb"))==null)
    {
        puts("打开文件cat.pic时错误");
        /* 如果打开失败则显示错误信息 */
        fclose(fin);
        return -1;
    }
    /* 从图像的第1行到第400行循环 */
    for(i = 0,j<400;j++)
    {
        b = fgetc(fin); /* 从输入文件中读入每像素的RGB值 */
        g = fgetc(fin);
        r = fgetc(fin);
        /* 按照公式 Y = 0.299R + 0.587G + 0.114B计算灰度值 */
        y = (0.299r + 0.587g + 0.114b)/1000;
        fputc(y.fout);
        /* 将计算出来的灰度值写到输出文件中去 */
    }
    fclose(fin);/* 关闭输入文件 */
    fclose(fout);/* 关闭输出文件 */
    return 0; /* 返回 0表示正确处理完毕*/
}

```

程序看完了吗？别找了别找了，这个程序没有功能上的问题。彩色变黑白，再简单不过了，上面的代码，肯定能给出再正确不过的cat2.pic来。

大家需要仔细找仔细看的时程序里的注释，你不觉得程序里的注释有问题吗？有什么问题？先不要问，再看一遍程序。你肯定已经找到了。不过在讨论这个案例以前，让我们再谈一些无关紧要的事情。

#### 2  一些题外话
一个公式，把彩色图像转换成灰度图像和使用黑白电视机播放彩色电视信号的原理是一样的。计算机里彩色图像大多被存储成RGB格式，也就是将具体的颜色分成红、绿、黄三个颜色分量。数字图像处理领域将这一表示方法称作RGB色彩空间。相应的，还有其他各种色彩空间，如HSV、YUY、CMKY、Lab等等。灰度图像的灰度值（或称明度值）就对应于YUY色彩空间中的Y分量值，也就是说，将彩色图像转换成灰度图像只需要作RGB到YUY的色彩空间变换，并取Y分量值作为灰度值就可以了。R、G、B三个分量与Y分量的换算关系是：
Y = 0.299R + 0.587G + 0.114B
上面的例子程序里就是使用这样的公式完成图像转换的。

一个小故事：两千多年前的春秋时侯，齐鲁大学校长孔子把得意门生颜回叫到跟前面授机宜。颜回听到老师的教导，抬头看看天，俯身看看地，脑筋急转弯，猛然发现自己吹捧老师的时机到了，于是在脸上堆出万分景仰的表情，对孔老师唱到：“大河向东流，天上的星星参北斗。老师就是北斗星啊，老师走来我也走。老师跑步我跟着溜，老师骑马我也把马鞭儿抖。老师您一骑绝尘、凤舞九天，徒弟我虽然还没把那梯云纵的轻功学到手，也要在后面为您喝彩叫好直喊到江水也倒流！”——顺便说一句，这个故事便是成语“亦步亦趋”的起源（见《庄子·田子方》）。

又一个小故事：清朝康熙年间，有两个大诗人，一个叫做邵长蘅，一个叫做宋荦。乾隆时候又出了一个大诗人叫洪亮吉。这洪亮吉与邵长蘅同乡，却偏偏在作诗的意见上与邵、宋二人相左。俗话说“文人相轻”，洪亮吉后来就在它的一部诗评中指摘邵长蘅说：“我那个同乡邵长蘅开始写诗的时候，只知道模仿盛唐的诗风，模仿得连自己都不知道姓李还是姓杜了，哪里还谈得上‘独到’二字！后来，邵长蘅到了宋荦的府中，又开始模仿宋荦的风格，简直是亦步亦趋，丢足了我们诗人的面子。”——再多说一句，这是古人把亦步亦趋运用得最为成功得一个例子（见清·洪亮吉《北江诗话》卷五）。

#### 3  案例分析
好，现在让我们正式开始讨论案例。代码Comments.c中得注释不可谓不多、不可谓不详，几乎到了一行代码一行注释得“最高境界”了。但仔细一读就会发现，这些注释得效率实在不高，价值实在不大，与其说是代码的注释，不如说是对代码的“白话文翻译”。什么叫“白话文翻译”呢？我们来看：
```
/* 以二进制只读方式打开文件并判断是否成功 */
if ((fin = fopen("cat.pic","rb")) == null)
```
这样的注释分明就是在说，“fopen()函数是用来打开文件的，rb参数是指只读、二进制方式，而非可写、文本方式，条件表达式判断的是打开文件是否成功……”絮絮叨叨，没完没了，好像全世界就只有他一个人会写C语言程序，会用C语言程序打开文件。这样的注释如果放在《N天学会C语言编程》之类的畅销书里，就再好不过了。
还有更绝的：
```
/* 按照公式 Y = 0.299R + 0.587G + 0.114B计算灰度值 */
y = (0.299r + 0.587g + 0.114b)/1000;
```
我看了表达式明白这是在计算灰度值，可就是不知道为什么这样算，不知道这样算是基于什么样的定理或公式；于是我去看注释，因为我相信注释里会有更多、更有价值的信息。可不看则已，等到我看见这样注释实际上就是把代码中的表达式利用分配律换了种写法，这时候，我就好像听到有人对我说：“你知道吗？一加二可以写成一加一再加一的。哦，什么，你早就知道了？真是不可思议，你简直太聪明了！”
第23页